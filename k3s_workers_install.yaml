- name: K3s worker nodes install
  hosts: workers
  gather_facts: no
  tasks:

    - name: mkdir /var/lib/rancher/k3s/agent/images/
      ansible.builtin.file:
        path: /var/lib/rancher/k3s/agent/images/
        state: directory
        mode: '0755'

    - name: Set k3s Executable
      ansible.builtin.copy:
        src: /share/k3s/k3s
        dest: /usr/local/bin/
        mode: '0755'

    - name: Set images
      ansible.builtin.copy:
        src: /share/k3s/k3s-airgap-images-amd64.tar
        dest: /var/lib/rancher/k3s/agent/images/

    - name: Set install script
      ansible.builtin.copy:
        src: /share/k3s/install.sh
        dest: /home/
        mode: '0755'

    - name: Get file for k3s-selinux
      ansible.builtin.copy:
        src: /share/k3s/k3s-selinux-1.4-1.el9.noarch.rpm
        dest: /home/

    - name: Get node-token for install
      ansible.builtin.copy:
        src: /home/rens/k3s/node-token
        dest: /home/

    - name: Set node-token variable
      shell: cat /home/node-token
      register: file_content

    - name: install k3s-selinux
      ansible.builtin.yum:
        name: /home/k3s-selinux-1.4-1.el9.noarch.rpm
        disable_gpg_check: True
        disablerepo: baseos,appstream,extras,extras-common
        state: present

    - name: Execute ./install.sh
      ansible.builtin.raw: INSTALL_K3S_SKIP_DOWNLOAD=true K3S_URL=https://192.168.1.10:6443 K3S_TOKEN='{{ file_content.stdout }}' /home/./install.sh